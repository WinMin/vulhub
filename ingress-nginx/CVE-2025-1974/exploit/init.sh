#!/bin/sh

echo "[INFO] Starting K3s server..."
/bin/k3s server &

echo "[INFO] Waiting for Kubernetes API to be ready..."
until /bin/kubectl get nodes > /dev/null 2>&1; do
  sleep 1
done

echo "[INFO] Installing ingress-nginx..."
/bin/kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.9.5/deploy/static/provider/baremetal/deploy.yaml

echo "[INFO] Waiting for ingress-nginx controller..."
/bin/kubectl wait --for=condition=available --timeout=600s deployment/ingress-nginx-controller -n ingress-nginx

echo "[INFO] Deploying exploit pod..."
/bin/kubectl apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: exploit-pod
spec:
  containers:
    - name: exploit
      image: python:3.10-slim
      command: [ "sh", "-c", "apt update && apt install -y vim && python3 -m pip install httpx requests && sleep infinity" ]
      volumeMounts:
        - name: exploit-volume
          mountPath: /exploit
  volumes:
    - name: exploit-volume
      hostPath:
        path: /exploit
        type: Directory
EOF

echo "[INFO] Waiting for exploit-pod to be ready..."
/bin/kubectl wait --for=condition=ready pod/exploit-pod --timeout=300s

echo "[INFO] All done. You can exec into exploit-pod now!"
/bin/kubectl exec -it exploit-pod -- bash

